# Spring Boot 主配置文件
# 支持多环境配置：使用 -Dspring.profiles.active=dev|prod 启动

spring:
  application:
    name: moyue-backend
  
  # 多环境数据源配置
  datasource:
    url: jdbc:h2:file:${moyue.data.home:~/MoyueData}/moyue;DB_CLOSE_DELAY=-1;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: ${DB_USERNAME:sa}
    password: ${DB_PASSWORD:}
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 30000
  
  # JPA 配置
  jpa:
    hibernate:
      ddl-auto: ${DDL_AUTO:update}
    show-sql: ${SHOW_SQL:false}
    open-in-view: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.H2Dialect
        format_sql: true
        use_sql_comments: true
  
  # H2 控制台（仅开发环境启用）
  h2:
    console:
      enabled: ${H2_CONSOLE_ENABLED:false}
      path: /h2-console
      settings:
        web-allow-others: false

# 服务器配置
server:
  port: ${SERVER_PORT:0}
  address: ${SERVER_ADDRESS:127.0.0.1}
  shutdown: graceful
  tomcat:
    threads:
      max: 200
      min-spare: 10

# 日志配置
logging:
  level:
    root: ${LOG_LEVEL_ROOT:INFO}
    com.moyue: ${LOG_LEVEL_APP:INFO}
    org.springframework: ${LOG_LEVEL_SPRING:WARN}
    org.hibernate: ${LOG_LEVEL_HIBERNATE:WARN}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${moyue.data.home:~/MoyueData}/logs/moyue-backend.log
    max-size: 50MB
    max-history: 30
    total-size-cap: 1GB

# 应用自定义配置
moyue:
  security:
    default-level: ${MOYUE_SECURITY_LEVEL:standard}  # standard | compatible | trusted
  data:
    home: ${MOYUE_DATA_HOME:~/MoyueData}
  
  # 性能配置
  performance:
    cache:
      enabled: true
      ttl: 3600  # 秒
      max-size: 1000
    
  # 书源配置
  book-source:
    max-concurrent-search: 5
    search-timeout: 30  # 秒
    request-timeout: 10  # 秒

# 管理端点（生产环境建议禁用）
management:
  endpoints:
    web:
      exposure:
        include: health,info
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
